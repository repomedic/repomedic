name: release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install CI tools
        run: task tools:install

      # Runs fmt, vet, lint, vulncheck, test
      - name: Run checks
        run: task check

  release:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          install-only: true
          version: latest

      - name: Delete existing release (idempotent re-run)
        run: gh release delete "${{ github.ref_name }}" --yes --cleanup-tag=false 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_PAT }}

      - name: Run release
        run: task release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_PAT }}

      # TODO: Re-enable WinGet PR verification after testing is complete.
      # The pull_request block in .goreleaser.yaml is currently commented out
      # so we don't spam microsoft/winget-pkgs with PRs during testing.
      # - name: Verify WinGet branch
      #   run: |
      #     set -euo pipefail
      #     version="${GITHUB_REF_NAME#v}"
      #     winget_branch="repomedic-${version}"
      #     echo "Checking that branch '${winget_branch}' exists on repomedic/winget-pkgsâ€¦"
      #     gh api "repos/repomedic/winget-pkgs/branches/${winget_branch}" --jq '.name'
      #     echo "Branch exists. Skipping PR verification (disabled for testing)."
      #   env:
      #     GH_TOKEN: ${{ secrets.GH_RELEASE_PAT }}

  test-winget:
    needs: release
    runs-on: windows-latest
    steps:
      - name: Determine version and branch
        id: meta
        shell: bash
        run: |
          version="${GITHUB_REF_NAME#v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"
          echo "branch=repomedic-${version}" >> "$GITHUB_OUTPUT"

      - name: Checkout winget manifest branch (sparse)
        shell: bash
        run: |
          set -euo pipefail
          branch="${{ steps.meta.outputs.branch }}"
          version="${{ steps.meta.outputs.version }}"
          manifest_dir="manifests/r/repomedic/repomedic/${version}"

          git clone --no-checkout --depth 1 --filter=blob:none \
            --branch "${branch}" \
            "https://github.com/repomedic/winget-pkgs.git" winget-pkgs

          cd winget-pkgs
          git sparse-checkout init --cone
          git sparse-checkout set "${manifest_dir}"
          git checkout

      - name: Enable local manifest files
        run: winget settings --enable LocalManifestFiles

      - name: Validate manifest
        run: |
          $version = "${{ steps.meta.outputs.version }}"
          winget validate --manifest ".\winget-pkgs\manifests\r\repomedic\repomedic\${version}"

      - name: Install from manifest
        run: |
          $version = "${{ steps.meta.outputs.version }}"
          winget install --manifest ".\winget-pkgs\manifests\r\repomedic\repomedic\${version}" --accept-source-agreements --accept-package-agreements

      - name: Verify installed version
        shell: bash
        run: |
          expected="${{ steps.meta.outputs.version }}"
          # repomedic -v may print something like "repomedic version 1.2.3"
          actual="$(repomedic -v 2>&1)"
          echo "Expected version: ${expected}"
          echo "Actual output:    ${actual}"
          if [[ "${actual}" != *"${expected}"* ]]; then
            echo "ERROR: Version mismatch!"
            exit 1
          fi
          echo "Version verified successfully."
