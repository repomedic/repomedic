name: release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install CI tools
        run: task tools:install

      # Runs fmt, vet, lint, vulncheck, test
      - name: Run checks
        run: task check

  release:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          install-only: true
          version: ~> v2

      - name: Delete existing release (idempotent re-run)
        run: gh release delete "${{ github.ref_name }}" --yes --cleanup-tag=false 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_PAT }}

      - name: Run release
        run: task release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_RELEASE_PAT }}

      - name: Verify WinGet PR
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          winget_branch="repomedic-${version}"
          echo "Checking that branch '${winget_branch}' exists on repomedic/winget-pkgs…"
          gh api "repos/repomedic/winget-pkgs/branches/${winget_branch}" --jq '.name'
          echo "Branch exists."

          echo "Checking for open PR against microsoft/winget-pkgs…"
          # Use the REST API directly instead of 'gh pr list' which relies
          # on GitHub's search index (often too slow on large repos).
          max_attempts=5
          for attempt in $(seq 1 $max_attempts); do
            delay=$((attempt * 10))
            pr_url=$(gh api "repos/microsoft/winget-pkgs/pulls?head=repomedic:${winget_branch}&state=open&per_page=1" \
              --jq '.[0].html_url // empty')

            if [[ -n "${pr_url}" ]]; then
              echo "PR found: ${pr_url}"
              exit 0
            fi

            if [[ $attempt -eq $max_attempts ]]; then
              echo "ERROR: No open PR found for head branch '${winget_branch}' after ${max_attempts} attempts!"
              exit 1
            fi

            echo "Attempt ${attempt}/${max_attempts}: PR not found yet. Retrying in ${delay}s…"
            sleep "$delay"
          done
        env:
          GH_TOKEN: ${{ secrets.GH_RELEASE_PAT }}

  test-brew:
    needs: release
    runs-on: macos-latest
    steps:
      - name: Determine version
        id: meta
        run: |
          version="${GITHUB_REF_NAME#v}"
          echo "version=${version}" >> "$GITHUB_OUTPUT"

      - name: Install from Homebrew tap
        run: |
          brew tap repomedic/tap
          brew install repomedic/tap/repomedic

      - name: Verify installed version
        run: |
          expected="${{ steps.meta.outputs.version }}"
          actual="$(repomedic -v 2>&1)"
          echo "Expected version: ${expected}"
          echo "Actual output:    ${actual}"
          if [[ "${actual}" != *"${expected}"* ]]; then
            echo "ERROR: Version mismatch!"
            exit 1
          fi
          echo "Version verified successfully."

  test-winget:
    needs: release
    runs-on: windows-latest
    steps:
      - name: Determine version and branch
        id: meta
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          "version=$version" >> $env:GITHUB_OUTPUT
          "branch=repomedic-$version" >> $env:GITHUB_OUTPUT

      - name: Checkout winget manifest branch (sparse)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $branch = "${{ steps.meta.outputs.branch }}"
          $version = "${{ steps.meta.outputs.version }}"
          $manifestDir = "manifests/r/repomedic/repomedic/$version"

          git clone --no-checkout --depth 1 --filter=blob:none `
            --branch $branch `
            "https://github.com/repomedic/winget-pkgs.git" winget-pkgs

          Set-Location winget-pkgs
          git sparse-checkout init --cone
          git sparse-checkout set $manifestDir
          git checkout

      - name: Enable local manifest files
        run: winget settings --enable LocalManifestFiles

      - name: Validate manifest
        run: |
          $version = "${{ steps.meta.outputs.version }}"
          winget validate --manifest ".\winget-pkgs\manifests\r\repomedic\repomedic\${version}"

      - name: Install from manifest
        run: |
          $version = "${{ steps.meta.outputs.version }}"
          winget install --manifest ".\winget-pkgs\manifests\r\repomedic\repomedic\${version}" --accept-source-agreements --accept-package-agreements

      - name: Verify installed version
        shell: pwsh
        run: |
          # Refresh PATH from the registry so the current session sees winget-installed binaries
          $machinePath = [Environment]::GetEnvironmentVariable("Path", "Machine")
          $userPath    = [Environment]::GetEnvironmentVariable("Path", "User")
          $env:Path    = "$machinePath;$userPath"

          $expected = "${{ steps.meta.outputs.version }}"
          $actual   = & repomedic -v 2>&1 | Out-String
          $actual   = $actual.Trim()
          Write-Host "Expected version: $expected"
          Write-Host "Actual output:    $actual"
          if ($actual -notmatch [regex]::Escape($expected)) {
            Write-Host "ERROR: Version mismatch!"
            exit 1
          }
          Write-Host "Version verified successfully."
